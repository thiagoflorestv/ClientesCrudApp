@model Clientes.Application.DTOs.ClienteDto
@using Clientes.Application.DTOs

@{
    ViewData["Title"] = "Editar Cliente";
    var telefonesCount = Model.Telefones?.Count ?? 0;
}

<h1>@ViewData["Title"]</h1>

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()

    <input type="hidden" asp-for="CodigoCliente" />

    <div class="mb-3">
        <label asp-for="RazaoSocial" class="form-label"></label>
        <input asp-for="RazaoSocial" class="form-control" />
        <span asp-validation-for="RazaoSocial" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="NomeFantasia" class="form-label"></label>
        <input asp-for="NomeFantasia" class="form-control" />
    </div>

    <div class="mb-3">
        <label asp-for="TipoPessoa" class="form-label"></label>
        <select asp-for="TipoPessoa" class="form-select">
            <option value="">-- Selecione --</option>
            <option value="Física" selected="@(Model.TipoPessoa == "Física" ? "selected" : null)">Física</option>
            <option value="Jurídica" selected="@(Model.TipoPessoa == "Jurídica" ? "selected" : null)">Jurídica</option>
        </select>
    </div>

    <div class="mb-3">
        <label asp-for="Documento" class="form-label"></label>
        <input asp-for="Documento" class="form-control" maxlength="18" oninput="formatarDocumento(this)" />
    </div>

    <div class="mb-3">
        <label asp-for="Endereco" class="form-label"></label>
        <input asp-for="Endereco" class="form-control" />
    </div>

    <div class="mb-3">
        <label asp-for="Complemento" class="form-label"></label>
        <input asp-for="Complemento" class="form-control" />
    </div>

    <div class="mb-3">
        <label asp-for="Bairro" class="form-label"></label>
        <input asp-for="Bairro" class="form-control" />
    </div>

    <div class="mb-3">
        <label asp-for="Cidade" class="form-label"></label>
        <input asp-for="Cidade" class="form-control" />
    </div>

    <div class="mb-3">
        <label asp-for="CEP" class="form-label"></label>
        <input asp-for="CEP" class="form-control" maxlength="9" oninput="formatarCEP(this)" />
    </div>

    <div class="mb-3">
        <label asp-for="UF" class="form-label"></label>
        <select asp-for="UF" class="form-select">
            <option value="">-- Selecione --</option>
            @foreach (var uf in new[] { "AC", "AL", "AP", "AM", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RS", "RO", "RR", "SC", "SP", "SE", "TO" })
            {
                <option value="@uf" selected="@(Model.UF == uf ? "selected" : null)">@uf</option>
            }
        </select>
    </div>

    <h4>Telefones</h4>
    <div id="telefones">
        @if (Model.Telefones != null)
        {
            for (int i = 0; i < Model.Telefones.Count; i++)
            {
                <div class="mb-2 border p-2 telefone-item">
                    <label>Número</label>
                    <input asp-for="Telefones[i].NumeroTelefone" class="form-control mb-1 telefone" oninput="formatarTelefone(this)" />

                    <label>Tipo</label>
                    <select asp-for="Telefones[i].CodigoTipoTelefone" class="form-control mb-1">
                        @foreach (TipoTelefoneDto tipo in ViewBag.TiposTelefone)
                        {
                            <option value="@tipo.CodigoTipoTelefone" selected="@(Model.Telefones[i].CodigoTipoTelefone == tipo.CodigoTipoTelefone ? "selected" : null)">
                                @tipo.DescricaoTipoTelefone
                            </option>
                        }
                    </select>

                    <label>Operadora</label>
                    <input asp-for="Telefones[i].Operadora" class="form-control mb-1" />
                </div>
            }
        }
    </div>

    <button type="button" class="btn btn-secondary mb-3" onclick="adicionarTelefone()">Adicionar Telefone</button>

    <div>
        <button type="submit" class="btn btn-success">Salvar</button>
        <a href="@Url.Action("Index")" class="btn btn-secondary">Voltar</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        var index = @telefonesCount;
        var tiposTelefoneOptions = `@foreach (TipoTelefoneDto tipo in ViewBag.TiposTelefone) {
        <text><option value='@tipo.CodigoTipoTelefone'>@tipo.DescricaoTipoTelefone</option></text>
    }
`;

    function adicionarTelefone() {
        var html = `<div class="mb-2 border p-2 telefone-item">
            <label>Número</label>
            <input name="Telefones[${index}].NumeroTelefone" class="form-control mb-1 telefone" oninput="formatarTelefone(this)" />

            <label>Tipo</label>
            <select name="Telefones[${index}].CodigoTipoTelefone" class="form-control mb-1">
                ${tiposTelefoneOptions}
            </select>

            <label>Operadora</label>
            <input name="Telefones[${index}].Operadora" class="form-control mb-1" />
        </div>`;
        document.getElementById("telefones").insertAdjacentHTML("beforeend", html);
        index++;
    }

    function formatarDocumento(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor.length <= 11) {
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
            valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
            valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
            valor = valor.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
        }
        input.value = valor;
    }

    function formatarCEP(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor.length > 5) valor = valor.replace(/^(\d{5})(\d)/, '$1-$2');
        input.value = valor;
    }

    function formatarTelefone(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor.length <= 10) {
            valor = valor.replace(/^(\d{2})(\d)/, '($1) $2');
            valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
        } else {
            valor = valor.replace(/^(\d{2})(\d)/, '($1) $2');
            valor = valor.replace(/(\d{5})(\d)/, '$1-$2');
        }
        input.value = valor;
    }
</script>
}
